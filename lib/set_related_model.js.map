{"version":3,"file":"set_related_model.js","names":["_isNumber","_interopRequireDefault","require","_isPlainObject","_find","_includes","_base_model","obj","__esModule","default","setRelatedModel","options","arguments","length","undefined","id","modelJson","relatedModel","model","relation","requestId","topLevelJson","existingRelatedModel","topLevelModelJson","topLevelJsonKey","find","isHasMany","propertyName","m","isHasOne","get","set","includes","push","reverseRelation","setReverseRelation","setMethodName"],"sources":["../src/set_related_model.js"],"sourcesContent":["import isNumber from 'lodash/isNumber';\nimport isPlainObject from 'lodash/isPlainObject';\nimport find from 'lodash/find';\nimport includes from 'lodash/includes';\n\nimport BaseModel from './base_model';\n\nexport default function setRelatedModel(options = {}) {\n\n  let {\n    id,\n    modelJson,\n    relatedModel, // related model instance, basically the same as existingRelatedModel\n    model,\n    relation,\n    requestId,\n    topLevelJson,\n  } = options;\n\n  let existingRelatedModel;\n  // id, json, relatedModel,   \n\n  if (!id && !modelJson && !relatedModel) return;\n\n  // if only id was passed, try to get json from top level\n  if (id && !modelJson) {\n    let topLevelModelJson = topLevelJson[relation.topLevelJsonKey];                  \n    if (topLevelModelJson) {\n      modelJson = find(topLevelModelJson, { id });\n    }\n  }\n\n  if (!id && modelJson) id = modelJson.id;\n  if (!id && relatedModel) id = relatedModel.id;\n\n\n\n  // try to find it in array by id if hasMany relation\n  if (relation.isHasMany) {\n    existingRelatedModel = model[relation.propertyName].find(m => m.id === id);\n  // or just check if property is assigned\n  } else if (relation.isHasOne) {\n    existingRelatedModel = model[relation.propertyName];\n    if (existingRelatedModel && existingRelatedModel.id !== id) existingRelatedModel = undefined;\n  }\n\n\n\n\n  // if no existing related model was not found \n  if (!existingRelatedModel) {\n\n    // if no related model was passed\n    if (!relatedModel) {    \n\n      // if no json passed, then just try to fetch model \n      // with given id from the store, if any\n      if (!modelJson) {\n\n        /*\n         * !!!!!!!!!!!!!!!!!!!!!!!!!!!\n         * TODO\n         */\n\n        relatedModel = relation.relatedModel.get(id)\n\n      // if not only id was passed in json then do regular\n      // processing\n      } else {\n\n        // add relation to its store\n        relatedModel = relation.relatedModel.set({\n          modelJson,\n          requestId,\n          topLevelJson\n        })\n\n      }\n    }\n\n    // if we finally got related model, or it was passed\n    // add it to relation property\n    if (relatedModel) {\n\n      // push new model to array\n      if (relation.isHasMany && !includes(model[relation.propertyName], relatedModel)) {\n        model[relation.propertyName].push(relatedModel);\n\n      // or just assign it to the property\n      } else if (relation.isHasOne) {\n        model[relation.propertyName] = relatedModel;\n      }\n\n      // if there is reverse relation, add current model\n      // to the related model's reverse relation.\n      let reverseRelation = relation.reverseRelation;\n      if (reverseRelation) {\n        let setReverseRelation = relatedModel[reverseRelation.setMethodName]\n        // console.log('reverseRelation', relation, relatedModel, reverseRelation.setMethodName, model)\n        if (setReverseRelation) setReverseRelation({ relatedModel: model });\n      }\n\n    }\n\n    return relatedModel;\n\n  // if there is existing related model\n  } else {\n\n    // update it with json if it was passed\n    if (modelJson) {\n      existingRelatedModel.set({\n        requestId,\n        modelJson,\n        topLevelJson\n      });\n    }\n\n    return existingRelatedModel;\n\n  }\n\n}"],"mappings":"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"}